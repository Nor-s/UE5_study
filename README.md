# **CH8 애니메이션 시스템 활용(몽타주, 노티파이)**

- 다단 공격 시스템 제작

## **몽타주: 여러 애셋 결합**

- 몽타주
  - 어떤 순서로든 동적으로 애니메이션 재생 가능
  - 트랜지션을 컨트롤하여 행동을 더욱 동적으로 설정 가능
  - 슬롯 그룹으로 나누고, 그룹에서 애님 그래프를 사용하여 캐릭터의 일정한 부분에서만 애니메이션 재생 가능(상체, 하체 분리하여 애니메이션 재생)
  - 여러 슬롯을 사용할 때, 애니메이션 타이밍이 동일한 길이인지 확인해야함(최상의 결과를 위해)
  - 자식 몽타주 생성하여, 애니메이션 일부분 교체 가능

- 공격 기능
   - 공격 입력: 누를 때마다 연속된 모션으로 공격
   - 스테이트 머신으로 구현한다면, 계속 스테이트를 추가해야함. 
      - 이를 해소해주는 몽타주 기능 

1. Animinstance에 몽타주 선언 및 지정
2. 애니메이션 블프에서 몽타주 재생 노드(몽타주 재생을 담당하는 슬롯 노드)를 애님 그래프에 추가
    - 애님 그래프를 우클릭해 애니메이션 노드 목록을 열고 
    - slot 검색어를 입력해 나오는 DefaultSlot 슬롯 메뉴사용
        - slot: 일회성 애니메이션 삽입하는 프록시 영역
        

### 참고

- UPROPERTY 키워드 
    - Anywherer 키워드난 아래와 같이 세분화 가능(EditAnywhere, VisibleAnywhere)
      - DefaultsOnly: 클래스의 기본값을 담당하는 블프 편집화면에서만 보임
      - InstanceOnly: 인스턴스의 속성을 보여주는 에디터 뷰포트에서만 보여짐


## **델리게이트**

- 몽타주 시스템이 구동 중이면, 몽타주가 플레이되지 않도록 기능을 구현해야함
- 델리게이트 
  - 몽타주 재생이 끝나면, 공격 가능하다고 알리는 방식
  - 일반적인 개념: 특정 객체가 해야 할 로직을 다른 객체가 대신 처리할 수 있도록 만드는 보편적인 설계의 개념을 의미
  - 언리얼에서의 개념: A 객체가 B객체에 작업 명령을 내릴 때 B 객체에 자신을 등록하고 B의 작업이 끝나면 이때 A에게 알려주는 설계방식

- OnMontageEnded
  - 애님 인스턴스에서 제공
  - 애니메이션 몽타주 재생이 끝나면 발동하는 델리게이트
  

### 참고

- UE에서 델리게이트는 두가지 종류
    - C++ 객체에만 사용할 수 있는 델리게이트
    - 블프, C++ 객체가 모두 사용할 수 있는 델리게이트 (다이내믹 델리게이트)

- 블프 오브젝트는 멤버 함수에 대한 정보를 저장하고 로딩하는 직렬화 메커니즘이 들어있음
    - 따라서, **블프와 관련된 C++ 함수에는 UFUNCTION 매크로를 사용**해야 함.
  
- 멀티캐스트 델리게이트
  - 블프와 호환되는 성질 외, 여러 함수를 등록할 수 있음
  - 행동이 끝나면, 등록된 모든 함수들에게 모두 알려주는 기능도 제공

- 시그니쳐(Signature)
  - UE이 제공하는 매크로를 통해 정의되는 델리게이트 형식
  - DECLARE_MULTICAST_DELEGATE 와 같은 매크로로 사용자 정의 델리게이트 생성 가능

- 시그니처 + 멀티캐스트 = 다이내믹 멀티캐스트 델리게이트
    - AddDynamic : C++ 인텔리센스 검색 x





## **노티파이**

- 노티파이
    - 애니메이션을 재생하는 동안 특정 타이밍에 애님 인스턴스에게 신호를 보냄
    - 일반 애니메이션과 몽타주 모두 사용 가능


- 노티파이가 추가된 몽타주 애니메이션을 재생하면..
    - 재생 구간에 위치한 노티파이를 호출하게 됨.
    - UE는 이를 보고 자동으로 애님 인스턴스 클래스의 'AnimNotify_노티파이명'이라는 이름의 멤버 함수를 찾아 호출
    - 이 함수는 반드시 UFUNCTION 매크로 사용해야함

## **콤보 공격의 구현**

- 공격 동작을 섹션으로 분리
  - Attack2, Attack3, Attack4
  - 섹션마다 공격 애니메이션을 하나씩 할당
  
- 애니메이션 노티파이 (NextAttackCheck) 는 Branching Point 값으로 틱 타입 설정
    - Queued 타입은 비동기 방식으로 신호를 받게됨, 적절한 타이밍에 신호를 놓칠 가능성 있음
    - Queued 값은 사운드, 이펙트 등에 사용

- 주의: 몽타주 에디터 > 애셋 디테일 > Blend Option > Blend Out Trigger Time > 0 으로 설정
  - 참고: https://blog.naver.com/PostView.naver?blogId=kzh8055&logNo=222044403660

## 참고

- 몽타주: https://docs.unrealengine.com/5.0/en-US/animation-montage-in-unreal-engine/
- 몽타주: https://docs.unrealengine.com/5.0/en-US/animation-montage-editor-in-unreal-engine/
- 슬롯: https://docs.unrealengine.com/5.0/en-US/animation-slots-in-unreal-engine/