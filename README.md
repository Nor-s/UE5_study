# **CH7 애니메이션 시스템의 설계**

- 애님 인스턴스 클래스를 C++로 제작
- 상태머신에 기반한 애니메이션 시스템 제작

## **애니메이션 블루 프린트**

- 애니메이션 블루프린트
  - 다양한 상황에 적절한 애니메이션을 체계적으로 재생하도록 애니메이션 시스템을 제작할 수 있는 도구
  - 두 가지로 구성됨
    - 애님 그래프
    - 애님 인스턴스
  
- 애님 인스턴스
  - 스케레탈 메시를 소유하는 폰의 정보를 받아, 애님 그래프가 참조할 데이터를 제공
  - 블프 or C++
   
- 애님 그래프
  - 애님 인스턴스의 변수 값에 따라 변화하는 애니메이션 시스템을 설계하는 공간
  - 블프로만 제작 가능

## **C++로 애님 인스턴스 제작**

- 폰의 현재 속력을 애님 인스턴스에 저장, 이 값에 따라 애님 그래프에서는 IDLE 애니메이션 or Run 애니메이션 재생
- 애니메이션 블프 더블클릭 > 클래스 세팅 > 부모 클래스 변경 > 컴파일  
  - 이를 통해 속력을 애님 그래프에서 이용 가능 (블프 매뉴 > 상속된 변수 표시)

## **폰과 데이터 연동**

- 폰의 속도에 따라 다른 애니메이션을 재생하기 위해서는 프레임마다 폰의 속력과 애님 인스턴스의 CurrentPawnSpeed 값이 같은 값을 가져야 함
- 두 방식이 있고 책에서는 두 번째 방식을 사용 (애니메이션 로직과 폰의 로직을 분리... 서버 코드에도 문제없이 동작하는 장점)
  1. 폰의 Tick에서 애님 인스턴스의 CurrentPawnSpeed를 동기화
     - GetAnimInstance 함수 사용
     - Instance에 SetSpeed 함수를 구현, Pawn 에서 호출
  2. 애님 인스턴스의 Tick에서 폰의 속도 정보를 가져온 후 동기화 
     - 애님 인스턴스의 틱마다 호출되는 NativeUpdateAnimation 가상 함수를 사용
     - TryGetPawnOwner 함수 사용, GetVelocity() 함수 사용


### **참고**

- 게임 엔진은 틱마다 입력 시스템 > 게임 로직 > 애니메이션 시스템순으로 로직을 실행함
  - 플레이어의 입력을 먼저 받고 해석 후 폰을 움직이게 만들고, 그에 맞는 애니메이션을 재생시키는 방식
- 만일 애니메이션 앞 단계인 게임 로직에서 폰을 제거하면, 그 뒤에 실행되는 애니메이션 로직은 유효하지 않은 폰 객체를 참조하게됨
  - 그러므로 애니메이션 시스템에서 폰에 접근할 때, 폰 객체 유효 검사를 수행해야함
    - TryGetPawnOwner 가 이를 수행하는 함수
  

## **스테이트 머신 제작**

- 애님 그레프의 스테이트 머신 기능(유한 상태 기계)
  - 반복적인 동작의 단위인 스테이트들로 구성됨
  - 그중 하나의 스테이트만 지정해 지정한 동작을 반복
  - 스테이트 == 애니메이션 동작


- 트렌지션 (단방향 화살표선, 룰)
  - 하나의 스테이트에서 다른 스테이트로 이동하기 위한 조건

- 시작 스테이트
  - Entry와 연결된 스테이트
  
## **점프**

- ACharacter 클래스 Jump 멤버 함수
  - 입력과 바인딩할 수 있게 인자와 반환이 없는 함수로 선언돼 있음.
  - 점프 입력과 연동하면 캐릭터의 점프 기능이 바로 완성됨
  - Jump 함수를 호출하면, JumpZVelocity 멤버 변수에 지정된 값만큼의 점프 속력을 가지고 점프함 (높이 조절)

- 점프 모션 재생
  - 점프 중인지, 땅 위에 있는지 알아야함
  - 폰의 무브먼트 컴포넌트는 IsFalling(), IsSwimming(), IsCrounching(), IsMoveOnGround() 함수를 제공함
  - 캐릭터 무브먼트 컴포넌트에 이 기능들이 제대로 구현되어 있음
  - IsFalling() 함수를 사용해 폰의 점프 여부 정보를 애님 인스턴스에 보관, 이를 활용해야함
  

## **리타겟팅**

- UE5에서의 리타겟팅은 UE4와 다르게 리타겟팅 메니저가 없음
    - IK RIG 에셋을 두 개 만들어야함

- [mixamo retargeting](./Docs/Mixamo%20Retargeting.pdf) 참고
    - 손가락 등 체인 역시 추가해도 됨.


### **참고**

- https://velog.io/@myverytinybrain/%EC%96%B8%EB%A6%AC%EC%96%BC-%EC%95%A0%EB%8B%88%EB%A9%94%EC%9D%B4%EC%85%98-%EB%A6%AC%ED%83%80%EA%B2%9F%ED%8C%85
- https://www.youtube.com/watch?v=N7WdyAeeDrw&t=42s

## **점프의 구현**

- 지형에 따라 체공 시간이 다름
  - 점프동작 = 도약, 체공, 착지
  - 상황에 맞게 애니메이션 재생 시간 조절해줘야함
  - 도약과 착지는 loop animation 옵션을 꺼야함
  - Automatic Rule Based on Sequence Player in State 옵션을 사용하여 애니메이션 종료 시 자동으로 상태전환 가능


